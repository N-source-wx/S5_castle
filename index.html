<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>賽季攻城地圖&分數計算器</title>
    <style>
        :root {
            /* 家族著色顏色 (RGB) */
            --orange: rgb(232, 149, 73);
            --green: rgb(82, 240, 104);
            --blue: rgb(150, 160, 255);
            --lightblue: rgb(181, 205, 243);
            
            /* 指定底圖預設 RGB */
            --layer-0-1: rgb(140, 95, 60);
            --layer-2-3: rgb(150, 120, 70);
            --layer-4: rgb(200, 175, 125);
            
            --stroke: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f6f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            user-select: none;
            overflow-x: hidden;
        }

        .page-title {
            font-size: 20px;
            font-weight: 900;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            text-align: center;
        }

        .header {
            width: 95%;
            margin-bottom: 20px;
            text-align: center;
        }

        .picker-label {
            font-size: 13px;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        /* 控制列布局 */
        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 統一所有按鈕的基礎樣式 */
        .control-item {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            border: 4px solid #fff;
            box-sizing: border-box; /* 確保邊框包含在寬高內 */
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        .color-btn.active {
            border-color: #2c3e50;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* 重置按鈕專屬外觀，但尺寸與 control-item 一致 */
        .reset-btn {
            background: #343a40;
            color: white;
            font-weight: bold;
            font-size: 12px;
            line-height: 1.2;
            text-align: center;
            outline: none;
        }

        .reset-btn:active {
            transform: scale(0.9);
            background: #000;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
            gap: 15px;
            padding-bottom: 80px;
        }

        .map-section {
            background: #fff;
            width: 90%;
            max-width: 600px;
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            touch-action: none;
        }

        svg {
            width: 100%;
            height: auto;
            touch-action: none;
        }

        .hex {
            stroke: var(--stroke);
            stroke-width: 0.8;
            cursor: pointer;
            transition: fill 0.1s ease;
        }

        .hex.l01 { fill: var(--layer-0-1); }
        .hex.l23 { fill: var(--layer-2-3); }
        .hex.l4 { fill: var(--layer-4); }

        .score-section {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .score-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .score-item:last-child { border-bottom: none; }

        .score-color-box {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            margin-right: 12px;
        }

        .score-info {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-score {
            font-weight: 900;
            font-size: 1.2rem;
            color: #2c3e50;
        }

        .count-badge {
            background: #f1f3f5;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .footer-signature {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 12px;
            color: #bdc3c7;
            font-weight: 500;
        }

        @media (min-width: 768px) {
            .main-container { flex-direction: row; justify-content: center; align-items: flex-start; }
            .map-section { width: 60%; }
            .score-section { width: 30%; }
        }
    </style>
</head>
<body>

<h1 class="page-title">賽季攻城地圖&分數計算器</h1>

<div class="header">
    <div class="picker-label">選擇顏色 / 重置紀錄</div>
    <div class="controls-row">
        <div class="control-item color-btn active" style="background: var(--orange)" data-color="orange"></div>
        <div class="control-item color-btn" style="background: var(--green)" data-color="green"></div>
        <div class="control-item color-btn" style="background: var(--blue)" data-color="blue"></div>
        <div class="control-item color-btn" style="background: var(--lightblue)" data-color="lightblue"></div>
        <button class="control-item reset-btn" onclick="resetMap()">重置<br>紀錄</button>
    </div>
</div>

<div class="main-container">
    <div class="map-section">
        <svg id="hexMap" viewBox="0 0 500 500"></svg>
    </div>

    <div class="score-section">
        <div id="statsBoard"></div>
    </div>
</div>

<div class="footer-signature">慕慕懶人包</div>

<script>
    const config = {
        size: 28,
        mapSize: 4,
        storageKey: 'mumu_hex_map_save_v4',
        colors: {
            orange: 'rgb(232, 149, 73)',
            green: 'rgb(82, 240, 104)',
            blue: 'rgb(150, 160, 255)',
            lightblue: 'rgb(181, 205, 243)',
            white: 'transparent'
        },
        scoreWeights: { layer0: 5000, layer1: 2200, layer23: 1900, layer4: 1600 }
    };

    let currentColor = 'orange';
    let isDrawing = false;
    let mode = 'paint'; 
    let hexData = [];

    function init() {
        const svg = document.getElementById('hexMap');
        const savedData = localStorage.getItem(config.storageKey);
        const parsedData = savedData ? JSON.parse(savedData) : null;

        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.dataset.color;
            });
        });

        for (let q = -config.mapSize; q <= config.mapSize; q++) {
            const r1 = Math.max(-config.mapSize, -q - config.mapSize);
            const r2 = Math.min(config.mapSize, -q + config.mapSize);
            
            for (let r = r1; r <= r2; r++) {
                const distance = Math.max(Math.abs(q), Math.abs(r), Math.abs(q + r));
                const x = 250 + config.size * (3/2 * q);
                const y = 250 + config.size * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r);
                
                const id = `hex-${q}-${r}`;
                const savedOwner = parsedData ? parsedData[id] : 'white';

                const hex = { id, distance, owner: savedOwner };
                hexData.push(hex);
                
                const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                polygon.setAttribute("id", hex.id);
                polygon.setAttribute("points", getHexPoints(x, y, config.size));
                
                let layerClass = "hex ";
                if (distance <= 1) layerClass += "l01";
                else if (distance <= 3) layerClass += "l23";
                else layerClass += "l4";
                
                polygon.setAttribute("class", layerClass);
                updateHexFill(polygon, hex.owner);
                
                polygon.addEventListener('mousedown', () => handleStart(hex));
                polygon.addEventListener('mouseenter', () => handleMove(hex));
                polygon.addEventListener('touchstart', (e) => { 
                    e.preventDefault(); 
                    handleStart(hex); 
                }, {passive: false});

                svg.appendChild(polygon);
            }
        }

        svg.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (target && target.tagName === 'polygon') {
                const hex = hexData.find(h => h.id === target.id);
                if (hex) handleMove(hex);
            }
        }, {passive: false});

        window.addEventListener('mouseup', () => { isDrawing = false; saveToLocalStorage(); });
        window.addEventListener('touchend', () => { isDrawing = false; saveToLocalStorage(); });

        updateStats();
    }

    function updateHexFill(element, owner) {
        element.style.fill = (owner === 'white') ? "" : config.colors[owner];
    }

    function saveToLocalStorage() {
        const dataToSave = {};
        hexData.forEach(h => { dataToSave[h.id] = h.owner; });
        localStorage.setItem(config.storageKey, JSON.stringify(dataToSave));
    }

    function getHexPoints(x, y, s) {
        let p = "";
        for (let i = 0; i < 6; i++) {
            const rad = (Math.PI / 180) * (60 * i);
            p += `${x + s * Math.cos(rad)},${y + s * Math.sin(rad)} `;
        }
        return p;
    }

    function handleStart(hex) {
        isDrawing = true;
        mode = (hex.owner === currentColor) ? 'erase' : 'paint';
        applyChange(hex, mode === 'erase' ? 'white' : currentColor);
    }

    function handleMove(hex) {
        if (!isDrawing) return;
        if (mode === 'paint') applyChange(hex, currentColor);
        else if (mode === 'erase' && hex.owner === currentColor) applyChange(hex, 'white');
    }

    function applyChange(hex, newColor) {
        if (hex.owner === newColor) return;
        hex.owner = newColor;
        updateHexFill(document.getElementById(hex.id), newColor);
        updateStats();
    }

    function updateStats() {
        const stats = { orange: { s: 0, c: 0 }, green: { s: 0, c: 0 }, blue: { s: 0, c: 0 }, lightblue: { s: 0, c: 0 } };
        hexData.forEach(h => {
            if (h.owner !== 'white') {
                let score = 0;
                if (h.distance === 0) score = config.scoreWeights.layer0;
                else if (h.distance === 1) score = config.scoreWeights.layer1;
                else if (h.distance <= 3) score = config.scoreWeights.layer23;
                else score = config.scoreWeights.layer4;
                stats[h.owner].s += score;
                stats[h.owner].c += 1;
            }
        });
        const board = document.getElementById('statsBoard');
        board.innerHTML = '';
        Object.keys(stats).forEach(c => {
            const item = document.createElement('div');
            item.className = 'score-item';
            item.innerHTML = `
                <div class="score-color-box" style="background: ${config.colors[c]}"></div>
                <div class="score-info">
                    <span class="total-score">${stats[c].s.toLocaleString()}</span>
                    <span class="count-badge">${stats[c].c} 區</span>
                </div>`;
            board.appendChild(item);
        });
    }

    function resetMap() {
        if (confirm("確定清空所有著色紀錄？")) {
            hexData.forEach(h => {
                h.owner = 'white';
                updateHexFill(document.getElementById(h.id), 'white');
            });
            localStorage.removeItem(config.storageKey);
            updateStats();
        }
    }

    init();
</script>
</body>
</html>