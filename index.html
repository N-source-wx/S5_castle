<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>賽季攻城地圖&分數計算器</title>
    <style>
        :root {
            --orange: rgb(232, 149, 73);
            --green: rgb(82, 240, 104);
            --blue: rgb(150, 160, 255);
            --lightblue: rgb(181, 205, 243);
            --layer-0-1: rgb(140, 95, 60);
            --layer-2-3: rgb(150, 120, 70);
            --layer-4: rgb(200, 175, 125);
            --stroke: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f6f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            user-select: none;
            overflow-x: hidden;
        }

        /* 標題自動縮放與禁止換列 */
        .page-title {
            width: 95%;
            font-size: clamp(16px, 5.5vw, 24px); 
            font-weight: 900;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
        }

        .header {
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            text-align: center;
        }

        .picker-label {
            font-size: 13px;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        /* 6按鈕單列配置 */
        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            flex-wrap: nowrap;
            width: 98%;
            margin: 0 auto;
        }

        .control-item {
            flex: 1 1 0%; 
            min-width: 0;
            max-width: 60px;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            border: 2px solid #fff;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        .color-btn.active {
            border-color: #2c3e50;
            transform: scale(1.05);
        }

        .btn-text {
            color: white;
            font-weight: bold;
            font-size: clamp(9px, 2.2vw, 11px);
            line-height: 1.1;
            text-align: center;
            pointer-events: none;
        }

        /* 功能按鈕統一深灰色 */
        .function-btn {
            background: #343a40;
            border: 2px solid #fff;
            outline: none;
        }

        .function-btn:active {
            transform: scale(0.9);
            background: #000;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
            gap: 15px;
            padding-bottom: 80px;
        }

        .map-section {
            background: #fff;
            width: 95%;
            max-width: 550px;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            touch-action: none;
        }

        svg { width: 100%; height: auto; touch-action: none; }

        .hex { stroke: var(--stroke); stroke-width: 0.8; cursor: pointer; }
        .hex.l01 { fill: var(--layer-0-1); }
        .hex.l23 { fill: var(--layer-2-3); }
        .hex.l4 { fill: var(--layer-4); }

        .hex-label {
            fill: rgba(255, 255, 255, 0.9);
            font-size: 8px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }
        .hex-label.hidden { display: none; }

        .score-section {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .score-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .score-color-box { width: 20px; height: 20px; border-radius: 6px; margin-right: 12px; }
        .score-info { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; }
        .total-score { font-weight: 900; font-size: 1.1rem; color: #2c3e50; }
        .count-badge { background: #f1f3f5; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; color: #6c757d; }

        .footer-signature {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 12px;
            color: #bdc3c7;
            font-weight: 500;
        }

        @media (min-width: 768px) {
            .main-container { flex-direction: row; justify-content: center; align-items: flex-start; }
            .map-section { width: 60%; }
            .score-section { width: 30%; }
        }
    </style>
</head>
<body>

<h1 class="page-title">賽季攻城地圖&分數計算器</h1>

<div class="header">
    <div class="picker-label">選擇顏色</div>
    <div class="controls-row">
        <div class="control-item color-btn active" style="background: var(--orange)" data-color="orange"></div>
        <div class="control-item color-btn" style="background: var(--green)" data-color="green"></div>
        <div class="control-item color-btn" style="background: var(--blue)" data-color="blue"></div>
        <div class="control-item color-btn" style="background: var(--lightblue)" data-color="lightblue"></div>
        <button class="control-item function-btn" onclick="toggleLabels()"><span class="btn-text" id="toggleLabelBtn">隱藏<br>編號</span></button>
        <button class="control-item function-btn" onclick="resetMap()"><span class="btn-text">重置<br>紀錄</span></button>
    </div>
</div>

<div class="main-container">
    <div class="map-section">
        <svg id="hexMap" viewBox="0 0 500 500"></svg>
    </div>
    <div class="score-section"><div id="statsBoard"></div></div>
</div>

<div class="footer-signature">慕慕懶人包 ver 1.2</div>

<script>
    const labelMap = {
        1:"1-8", 2:"1-10", 3:"1-12", 4:"1-14", 5:"1-16", 6:"1-6", 7:"2-6", 8:"2-8", 9:"2-10", 10:"2-12",
        11:"1-18", 12:"1-4", 13:"2-4", 14:"3-4", 15:"3-6", 16:"3-8", 17:"2-14", 18:"1-20", 19:"1-2", 20:"2-2",
        21:"3-2", 22:"4-2", 23:"4-4", 24:"3-10", 25:"2-16", 26:"1-22", 27:"1-1", 28:"2-1", 29:"3-1", 30:"4-1",
        31:"5-1", 32:"4-6", 33:"3-12", 34:"2-18", 35:"1-24", 36:"1-3", 37:"2-3", 38:"3-3", 39:"4-3", 40:"4-5",
        41:"3-11", 42:"2-17", 43:"1-23", 44:"1-5", 45:"2-5", 46:"3-5", 47:"3-7", 48:"3-9", 49:"2-15", 50:"1-21",
        51:"1-7", 52:"2-7", 53:"2-9", 54:"2-11", 55:"2-13", 56:"1-19", 57:"1-9", 58:"1-11", 59:"1-13", 60:"1-15", 61:"1-17"
    };

    const config = {
        size: 28,
        mapSize: 4,
        storageKey: 'mumu_hex_map_save_v4',
        colors: {
            orange: 'rgb(232, 149, 73)',
            green: 'rgb(82, 240, 104)',
            blue: 'rgb(150, 160, 255)',
            lightblue: 'rgb(181, 205, 243)',
            white: 'transparent'
        },
        scoreWeights: { layer0: 5000, layer1: 2200, layer23: 1900, layer4: 1600 }
    };

    let currentColor = 'orange';
    let isDrawing = false;
    let mode = 'paint'; 
    let hexData = [];
    let showLabels = true;

    function init() {
        const svg = document.getElementById('hexMap');
        const savedData = localStorage.getItem(config.storageKey);
        const parsedData = savedData ? JSON.parse(savedData) : null;

        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.dataset.color;
            });
        });

        let counter = 1;
        for (let q = -config.mapSize; q <= config.mapSize; q++) {
            const r1 = Math.max(-config.mapSize, -q - config.mapSize);
            const r2 = Math.min(config.mapSize, -q + config.mapSize);
            
            for (let r = r1; r <= r2; r++) {
                const distance = Math.max(Math.abs(q), Math.abs(r), Math.abs(q + r));
                const x = 250 + config.size * (3/2 * q);
                const y = 250 + config.size * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r);
                
                const id = `hex-${q}-${r}`;
                const customLabel = labelMap[counter] || ""; 
                const savedOwner = parsedData ? parsedData[id] : 'white';

                const hex = { id, distance, owner: savedOwner };
                hexData.push(hex);
                
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                polygon.setAttribute("id", hex.id);
                polygon.setAttribute("points", getHexPoints(x, y, config.size));
                
                let layerClass = "hex ";
                if (distance <= 1) layerClass += "l01";
                else if (distance <= 3) layerClass += "l23";
                else layerClass += "l4";
                
                polygon.setAttribute("class", layerClass);
                updateHexFill(polygon, hex.owner);

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x);
                text.setAttribute("y", y);
                text.setAttribute("class", "hex-label");
                text.textContent = customLabel;
                
                polygon.addEventListener('mousedown', () => handleStart(hex));
                polygon.addEventListener('mouseenter', () => handleMove(hex));
                polygon.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(hex); }, {passive: false});

                g.appendChild(polygon);
                g.appendChild(text);
                svg.appendChild(g);
                counter++;
            }
        }

        svg.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (target && target.tagName === 'polygon') {
                const hex = hexData.find(h => h.id === target.id);
                if (hex) handleMove(hex);
            }
        }, {passive: false});

        window.addEventListener('mouseup', () => { isDrawing = false; saveToLocalStorage(); });
        window.addEventListener('touchend', () => { isDrawing = false; saveToLocalStorage(); });

        updateStats();
    }

    function toggleLabels() {
        showLabels = !showLabels;
        const labels = document.querySelectorAll('.hex-label');
        const btnText = document.getElementById('toggleLabelBtn');
        labels.forEach(l => l.classList.toggle('hidden', !showLabels));
        btnText.innerHTML = showLabels ? "隱藏<br>編號" : "顯示<br>編號";
    }

    function updateHexFill(element, owner) {
        element.style.fill = (owner === 'white') ? "" : config.colors[owner];
    }

    function saveToLocalStorage() {
        const dataToSave = {};
        hexData.forEach(h => { dataToSave[h.id] = h.owner; });
        localStorage.setItem(config.storageKey, JSON.stringify(dataToSave));
    }

    function getHexPoints(x, y, s) {
        let p = "";
        for (let i = 0; i < 6; i++) {
            const rad = (Math.PI / 180) * (60 * i);
            p += `${x + s * Math.cos(rad)},${y + s * Math.sin(rad)} `;
        }
        return p;
    }

    function handleStart(hex) {
        isDrawing = true;
        mode = (hex.owner === currentColor) ? 'erase' : 'paint';
        applyChange(hex, mode === 'erase' ? 'white' : currentColor);
    }

    function handleMove(hex) {
        if (!isDrawing) return;
        if (mode === 'paint') applyChange(hex, currentColor);
        else if (mode === 'erase' && hex.owner === currentColor) applyChange(hex, 'white');
    }

    function applyChange(hex, newColor) {
        if (hex.owner === newColor) return;
        hex.owner = newColor;
        updateHexFill(document.getElementById(hex.id), newColor);
        updateStats();
    }

    function updateStats() {
        const stats = { orange: { s: 0, c: 0 }, green: { s: 0, c: 0 }, blue: { s: 0, c: 0 }, lightblue: { s: 0, c: 0 } };
        hexData.forEach(h => {
            if (h.owner !== 'white') {
                let score = 0;
                if (h.distance === 0) score = config.scoreWeights.layer0;
                else if (h.distance === 1) score = config.scoreWeights.layer1;
                else if (h.distance <= 3) score = config.scoreWeights.layer23;
                else score = config.scoreWeights.layer4;
                stats[h.owner].s += score;
                stats[h.owner].c += 1;
            }
        });
        const board = document.getElementById('statsBoard');
        board.innerHTML = '';
        Object.keys(stats).forEach(c => {
            const item = document.createElement('div');
            item.className = 'score-item';
            item.innerHTML = `
                <div class="score-color-box" style="background: ${config.colors[c]}"></div>
                <div class="score-info">
                    <span class="total-score">${stats[c].s.toLocaleString()}</span>
                    <span class="count-badge">${stats[c].c} 區</span>
                </div>`;
            board.appendChild(item);
        });
    }

    function resetMap() {
        if (confirm("確定清空所有著色紀錄？")) {
            hexData.forEach(h => {
                h.owner = 'white';
                updateHexFill(document.getElementById(h.id), 'white');
            });
            localStorage.removeItem(config.storageKey);
            updateStats();
        }
    }

    init();
</script>
</body>
</html>